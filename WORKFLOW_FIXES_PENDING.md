# GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¿®æ­£ï¼ˆæ‰‹å‹•é©ç”¨ãŒå¿…è¦ï¼‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€GitHub Appæ¨©é™ã®åˆ¶é™ã«ã‚ˆã‚Šãƒ—ãƒƒã‚·ãƒ¥ã§ããªã‹ã£ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´å†…å®¹ã‚’è¨˜éŒ²ã—ã¦ã„ã¾ã™ã€‚

## çŠ¶æ³

GitHub Appã«ã¯`.github/workflows/`å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã™ã‚‹`workflows`æ¨©é™ãŒãªã„ãŸã‚ã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã§ãã¾ã›ã‚“ã§ã—ãŸï¼š

1. `.github/workflows/deploy.yml`
2. `.github/workflows/phase2-quality-gate.yml`
3. `.github/workflows/qa-pipeline.yml`

## å¿…è¦ãªä¿®æ­£å†…å®¹

### 1. deploy.yml ã®ä¿®æ­£

#### å¤‰æ›´1: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤ã®æ¡ä»¶è¿½åŠ 
```yaml
# å¤‰æ›´å‰:
if: github.ref == 'refs/heads/main'

# å¤‰æ›´å¾Œ:
if: github.ref == 'refs/heads/main' && vars.ENABLE_STAGING_DEPLOY == 'true'
```

#### å¤‰æ›´2: SSHè¨­å®šã®æ¡ä»¶è¿½åŠ 
```yaml
# è¿½åŠ :
if: secrets.STAGING_SSH_KEY != ''
```

#### å¤‰æ›´3: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã®æ¡ä»¶è¿½åŠ 
```yaml
# è¿½åŠ :
if: secrets.STAGING_SSH_KEY != '' && secrets.STAGING_HOST != ''
```

#### å¤‰æ›´4: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã®ä¾å­˜é–¢ä¿‚å¤‰æ›´
```yaml
# å¤‰æ›´å‰:
needs: [test, security, deploy-staging]

# å¤‰æ›´å¾Œ:
needs: [test, security]
```

#### å¤‰æ›´5: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã®æ¡ä»¶è¿½åŠ 
```yaml
# å¤‰æ›´å‰:
if: github.ref == 'refs/heads/production' || startsWith(github.ref, 'refs/tags/v')

# å¤‰æ›´å¾Œ:
if: (github.ref == 'refs/heads/production' || startsWith(github.ref, 'refs/tags/v')) && vars.ENABLE_PRODUCTION_DEPLOY == 'true'
```

#### å¤‰æ›´6: Slacké€šçŸ¥ã®æ¡ä»¶è¿½åŠ 
```yaml
# å¤‰æ›´å‰:
if: success()

# å¤‰æ›´å¾Œ:
if: success() && secrets.SLACK_WEBHOOK != ''
```

#### å¤‰æ›´7: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¸ãƒ§ãƒ–ã®æ¡ä»¶è¿½åŠ 
```yaml
# å¤‰æ›´å‰:
if: always()

# å¤‰æ›´å¾Œ:
if: always() && needs.deploy-production.result != 'skipped' && secrets.PRODUCTION_SSH_KEY != ''
```

### 2. phase2-quality-gate.yml ã®ä¿®æ­£

#### å¤‰æ›´1: bcã‚³ãƒãƒ³ãƒ‰ã‚’awkã«ç½®ãæ›ãˆ
```yaml
# å¤‰æ›´å‰:
if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then

# å¤‰æ›´å¾Œ:
# bc ã‚³ãƒãƒ³ãƒ‰ã®ä»£ã‚ã‚Šã« awk ã‚’ä½¿ç”¨
if awk -v cov="$COVERAGE" -v thr="$THRESHOLD" 'BEGIN {exit !(cov < thr)}'; then
```

#### å¤‰æ›´2: Slacké€šçŸ¥ã®æ¡ä»¶è¿½åŠ 
```yaml
# å¤‰æ›´å‰:
if: always()

# å¤‰æ›´å¾Œ:
if: always() && secrets.SLACK_WEBHOOK != ''
```

### 3. qa-pipeline.yml ã®ä¿®æ­£

#### å¤‰æ›´1: Slacké€šçŸ¥ã®æ¡ä»¶è¿½åŠ 
```yaml
# å¤‰æ›´å‰:
if: always()

# å¤‰æ›´å¾Œ:
if: always() && secrets.SLACK_WEBHOOK != ''
```

## ä¿®æ­£ã®ç›®çš„

1. **bcã‚³ãƒãƒ³ãƒ‰ã®ç½®ãæ›ãˆ**: Ubuntuç’°å¢ƒã§bcãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€awkã‚’ä½¿ç”¨
2. **æ¡ä»¶ä»˜ãå®Ÿè¡Œ**: ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚„ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã«ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€ã‚¨ãƒ©ãƒ¼ã‚’é˜²æ­¢
3. **ä¾å­˜é–¢ä¿‚ã®æœ€é©åŒ–**: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤ãŒç„¡åŠ¹ã®å ´åˆã§ã‚‚æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¯èƒ½ã«

## é©ç”¨æ–¹æ³•

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³1: GitHubã®Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‹ã‚‰ç·¨é›†
1. GitHubãƒªãƒã‚¸ãƒˆãƒªã®Webã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹
2. å„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã„ã¦ç·¨é›†
3. ä¸Šè¨˜ã®å¤‰æ›´ã‚’æ‰‹å‹•ã§é©ç”¨
4. ã‚³ãƒŸãƒƒãƒˆã—ã¦ä¿å­˜

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³2: GitHub Appã«æ¨©é™ã‚’ä»˜ä¸
1. GitHub Appã®è¨­å®šã§`workflows`æ¨©é™ã‚’æœ‰åŠ¹åŒ–
2. ãƒ­ãƒ¼ã‚«ãƒ«ã®å¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥:
   ```bash
   git add .github/workflows/*.yml
   git commit -m "ğŸ”§ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¡ä»¶ä»˜ãå®Ÿè¡Œã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„"
   git push
   ```

### ã‚ªãƒ—ã‚·ãƒ§ãƒ³3: ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã®é©ç”¨
ãƒ‘ãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ï¼š
- `/tmp/deploy-workflow-changes.patch`
- `/tmp/phase2-workflow-changes.patch`
- `/tmp/qa-workflow-changes.patch`

## ç¾åœ¨ã®çŠ¶æ…‹

âœ… **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ§‹é€ ã®å¾©å…ƒ**: å®Œäº†ãƒ»ãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿
âœ… **ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®è¿½åŠ **: å®Œäº†ãƒ»ãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿
âš ï¸ **ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£**: å®Œäº†ï¼ˆæ‰‹å‹•é©ç”¨ãŒå¿…è¦ï¼‰

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ§‹é€ ã®å¾©å…ƒã«ã‚ˆã‚Šã€GitHub Actionsã®ä¸»è¦ãªã‚¨ãƒ©ãƒ¼ï¼ˆbackendãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸åœ¨ã€package.jsonä¸åœ¨ï¼‰ã¯è§£æ±ºã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿®æ­£ã¯ã€ã‚ˆã‚Šå …ç‰¢ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨æ¡ä»¶ä»˜ãå®Ÿè¡Œã®ãŸã‚ã®æœ€é©åŒ–ã§ã™ã€‚
