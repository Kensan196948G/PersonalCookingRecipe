name: ðŸ”§ GitHub Actions ã‚¨ãƒ©ãƒ¼è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ 

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      max_attempts:
        description: 'Maximum retry attempts'
        required: false
        default: '10'
      interval_minutes:
        description: 'Interval between retries (minutes)'
        required: false
        default: '30'

env:
  ISSUE_LABEL_AUTO_FIX: 'auto-fix'
  ISSUE_LABEL_CI_CD: 'ci-cd'
  ISSUE_LABEL_BUG: 'bug'

jobs:
  detect-errors:
    name: Detect Errors
    runs-on: ubuntu-latest
    outputs:
      has_failures: ${{ steps.check.outputs.has_failures }}
      failed_workflows: ${{ steps.check.outputs.failed_workflows }}
      failure_count: ${{ steps.check.outputs.failure_count }}

    steps:
      - name: Check for failed workflows
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Detecting failed workflows..."

          FAILURES=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs | map(select(.conclusion == "failure" and .name != "ðŸ”§ GitHub Actions ã‚¨ãƒ©ãƒ¼è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ")) | length')

          FAILED_NAMES=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq '[.workflow_runs | map(select(.conclusion == "failure" and .name != "ðŸ”§ GitHub Actions ã‚¨ãƒ©ãƒ¼è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ")) | .[0:5] | .[].name] | unique | join(", ")')

          echo "failure_count=$FAILURES" >> $GITHUB_OUTPUT
          echo "failed_workflows=$FAILED_NAMES" >> $GITHUB_OUTPUT

          if [ "$FAILURES" -gt 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
            echo "Found $FAILURES failures"
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "No failures found"
          fi

  manage-issue:
    name: Manage Issue
    runs-on: ubuntu-latest
    needs: detect-errors
    if: needs.detect-errors.outputs.has_failures == 'true'
    outputs:
      issue_number: ${{ steps.issue.outputs.issue_number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create or update issue
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING_ISSUE=$(gh issue list --label "${{ env.ISSUE_LABEL_AUTO_FIX }}" --state open --json number --jq '.[0].number // empty')

          FAILURE_COUNT="${{ needs.detect-errors.outputs.failure_count }}"
          FAILED_WORKFLOWS="${{ needs.detect-errors.outputs.failed_workflows }}"
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S JST')

          ISSUE_BODY="## GitHub Actions Auto Fix Report

          ### Status
          * Detection Time: ${TIMESTAMP}
          * Failed Workflows: ${FAILURE_COUNT}
          * Targets: ${FAILED_WORKFLOWS}

          ### Next Actions
          * [ ] Identify error cause
          * [ ] Execute auto fix
          * [ ] Verify results

          ---
          This issue is automatically managed by ðŸ”§ GitHub Actions ã‚¨ãƒ©ãƒ¼è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ."

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Updating existing Issue #$EXISTING_ISSUE"
            gh issue edit "$EXISTING_ISSUE" --body "$ISSUE_BODY"
            echo "issue_number=$EXISTING_ISSUE" >> $GITHUB_OUTPUT
          else
            echo "Creating new Issue"
            NEW_ISSUE=$(gh issue create \
              --title "[Auto Fix] GitHub Actions Error - $(date '+%Y-%m-%d')" \
              --body "$ISSUE_BODY" \
              --label "${{ env.ISSUE_LABEL_AUTO_FIX }},${{ env.ISSUE_LABEL_CI_CD }},${{ env.ISSUE_LABEL_BUG }}" \
              | grep -oE '[0-9]+$')
            echo "issue_number=$NEW_ISSUE" >> $GITHUB_OUTPUT
            echo "Created Issue #$NEW_ISSUE"
          fi

  auto-fix:
    name: Auto Fix
    runs-on: ubuntu-latest
    needs: [detect-errors, manage-issue]
    if: needs.detect-errors.outputs.has_failures == 'true'
    timeout-minutes: 360

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: |
          npm ci || npm install
          if [ -f src/package.json ]; then
            cd src && npm ci || npm install
          fi

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Auto Fix"
          git config --global user.email "auto-fix@github.com"

      - name: Auto fix loop
        id: fix_loop
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAX_ATTEMPTS: ${{ github.event.inputs.max_attempts || '10' }}
          INTERVAL_MINUTES: ${{ github.event.inputs.interval_minutes || '30' }}
          ISSUE_NUMBER: ${{ needs.manage-issue.outputs.issue_number }}
        run: |
          echo "Starting auto fix system"
          echo "Max attempts: $MAX_ATTEMPTS"
          echo "Interval: ${INTERVAL_MINUTES} minutes"

          ATTEMPT=1
          TOTAL_FIXES=0

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo ""
            echo "========================================="
            echo "Attempt $ATTEMPT / $MAX_ATTEMPTS"
            echo "========================================="

            CURRENT_FAILURES=$(gh api repos/${{ github.repository }}/actions/runs \
              --jq '.workflow_runs | map(select(.conclusion == "failure" and .name != "ðŸ”§ GitHub Actions ã‚¨ãƒ©ãƒ¼è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ")) | length')

            if [ "$CURRENT_FAILURES" -eq 0 ]; then
              echo "All workflows successful!"

              gh issue comment "$ISSUE_NUMBER" --body "## Fix Complete

              All workflows are now working correctly.

              * Completion Time: $(date '+%Y-%m-%d %H:%M:%S JST')
              * Total Attempts: $ATTEMPT
              * Total Fixes: $TOTAL_FIXES"

              gh issue close "$ISSUE_NUMBER" --reason completed
              echo "total_fixes=$TOTAL_FIXES" >> $GITHUB_OUTPUT
              echo "final_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "Found $CURRENT_FAILURES failures"

            if [ -f scripts/github-actions-auto-fix.js ]; then
              echo "Running auto fix script..."
              node scripts/github-actions-auto-fix.js || true
              TOTAL_FIXES=$((TOTAL_FIXES + 1))
            fi

            gh issue comment "$ISSUE_NUMBER" --body "### Attempt $ATTEMPT / $MAX_ATTEMPTS

            * Time: $(date '+%Y-%m-%d %H:%M:%S JST')
            * Errors: $CURRENT_FAILURES
            * Fixes: $TOTAL_FIXES
            * Next: ${INTERVAL_MINUTES} minutes"

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "Waiting ${INTERVAL_MINUTES} minutes..."
              sleep $((INTERVAL_MINUTES * 60))
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "Max attempts reached"
          echo "total_fixes=$TOTAL_FIXES" >> $GITHUB_OUTPUT
          echo "final_status=max_attempts_reached" >> $GITHUB_OUTPUT

          gh issue comment "$ISSUE_NUMBER" --body "## Max Attempts Reached

          Some workflows are still failing after $MAX_ATTEMPTS attempts.

          * Time: $(date '+%Y-%m-%d %H:%M:%S JST')
          * Fixes: $TOTAL_FIXES

          Manual intervention may be required."

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-fix-logs-${{ github.run_number }}
          path: |
            logs/auto-fix-*.log
            logs/*.log
          retention-days: 30

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ”§ GitHub Actions ã‚¨ãƒ©ãƒ¼è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ  Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Time | $(date '+%Y-%m-%d %H:%M:%S JST') |" >> $GITHUB_STEP_SUMMARY
          echo "| Run | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Attempts | ${{ github.event.inputs.max_attempts || '10' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Interval | ${{ github.event.inputs.interval_minutes || '30' }} min |" >> $GITHUB_STEP_SUMMARY
          echo "| Issue | #${{ needs.manage-issue.outputs.issue_number }} |" >> $GITHUB_STEP_SUMMARY

  close-on-success:
    name: Close Issue on Success
    runs-on: ubuntu-latest
    needs: detect-errors
    if: needs.detect-errors.outputs.has_failures == 'false'

    steps:
      - name: Close existing issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "All workflows working correctly"

          EXISTING_ISSUE=$(gh issue list --repo ${{ github.repository }} --label "auto-fix" --state open --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "Closing Issue #$EXISTING_ISSUE"
            gh issue comment "$EXISTING_ISSUE" --repo ${{ github.repository }} --body "## All Workflows Normal

            All workflows are working correctly.

            * Check Time: $(date '+%Y-%m-%d %H:%M:%S JST')

            This issue will be closed automatically."

            gh issue close "$EXISTING_ISSUE" --repo ${{ github.repository }} --reason completed
            echo "Issue #$EXISTING_ISSUE closed"
          else
            echo "No issue to close"
          fi
