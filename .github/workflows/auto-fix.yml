name: ğŸ”§ GitHub Actions è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ 

on:
  schedule:
    # 30åˆ†ã”ã¨ã«å®Ÿè¡Œ (ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ãƒ»ä¿®å¾©ã‚µã‚¤ã‚¯ãƒ«)
    - cron: '*/30 * * * *'
  workflow_dispatch:
    inputs:
      max_attempts:
        description: 'æœ€å¤§è©¦è¡Œå›æ•°'
        required: false
        default: '10'
      interval_minutes:
        description: 'è©¦è¡Œé–“éš”ï¼ˆåˆ†ï¼‰'
        required: false
        default: '30'
      dry_run:
        description: 'Dry Run ãƒ¢ãƒ¼ãƒ‰ï¼ˆtrue/falseï¼‰'
        required: false
        default: 'false'
      create_issue:
        description: 'Issueä½œæˆï¼ˆtrue/falseï¼‰'
        required: false
        default: 'true'

env:
  ISSUE_LABEL_AUTO_FIX: 'auto-fix'
  ISSUE_LABEL_CI_CD: 'ci-cd'
  ISSUE_LABEL_BUG: 'bug'

jobs:
  # ã‚¸ãƒ§ãƒ–1: ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
  detect-errors:
    name: ğŸ” ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥
    runs-on: ubuntu-latest
    outputs:
      has_failures: ${{ steps.check.outputs.has_failures }}
      failed_workflows: ${{ steps.check.outputs.failed_workflows }}
      failure_count: ${{ steps.check.outputs.failure_count }}

    steps:
      - name: å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ¤œå‡º
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ” å¤±æ•—ã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ¤œå‡ºä¸­..."

          # éå»24æ™‚é–“ã®å¤±æ•—ã‚’å–å¾—
          FAILURES=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq '.workflow_runs | map(select(.conclusion == "failure" and .name != "ğŸ”§ GitHub Actions è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ")) | length')

          FAILED_NAMES=$(gh api repos/${{ github.repository }}/actions/runs \
            --jq '[.workflow_runs | map(select(.conclusion == "failure" and .name != "ğŸ”§ GitHub Actions è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ")) | .[0:5] | .[].name] | unique | join(", ")')

          echo "failure_count=$FAILURES" >> $GITHUB_OUTPUT
          echo "failed_workflows=$FAILED_NAMES" >> $GITHUB_OUTPUT

          if [ "$FAILURES" -gt 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ $FAILURES ä»¶ã®å¤±æ•—ã‚’æ¤œå‡º"
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
            echo "âœ… å¤±æ•—ãªã—"
          fi

  # ã‚¸ãƒ§ãƒ–2: Issueç®¡ç†
  manage-issue:
    name: ğŸ“‹ Issueç®¡ç†
    runs-on: ubuntu-latest
    needs: detect-errors
    if: needs.detect-errors.outputs.has_failures == 'true'
    outputs:
      issue_number: ${{ steps.issue.outputs.issue_number }}

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: æ—¢å­˜Issueã‚’æ¤œç´¢ã¾ãŸã¯æ–°è¦ä½œæˆ
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“‹ Issueç®¡ç†ã‚’é–‹å§‹..."

          # æ—¢å­˜ã®auto-fix Issueã‚’æ¤œç´¢
          EXISTING_ISSUE=$(gh issue list --label "${{ env.ISSUE_LABEL_AUTO_FIX }}" --state open --json number --jq '.[0].number // empty')

          FAILURE_COUNT="${{ needs.detect-errors.outputs.failure_count }}"
          FAILED_WORKFLOWS="${{ needs.detect-errors.outputs.failed_workflows }}"

          ISSUE_BODY="## ğŸ”§ GitHub Actions è‡ªå‹•ä¿®å¾©ãƒ¬ãƒãƒ¼ãƒˆ

### ğŸ“Š æ¤œå‡ºçŠ¶æ³
- **æ¤œå‡ºæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S JST')
- **å¤±æ•—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ•°**: ${FAILURE_COUNT}ä»¶
- **å¯¾è±¡ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: ${FAILED_WORKFLOWS}

### ğŸ”„ ä¿®å¾©çŠ¶æ³
| è©¦è¡Œå›æ•° | çŠ¶æ…‹ | ä¿®å¾©å†…å®¹ |
|---------|------|---------|
| 1 | ğŸ”„ å®Ÿè¡Œä¸­ | ã‚¨ãƒ©ãƒ¼åˆ†æãƒ»ä¿®å¾©ä¸­ |

### ğŸ“ ä¿®å¾©ãƒ­ã‚°
\`\`\`
$(date '+%Y-%m-%d %H:%M:%S') - è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•
$(date '+%Y-%m-%d %H:%M:%S') - ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥: ${FAILURE_COUNT}ä»¶
\`\`\`

### ğŸ¯ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
- [ ] ã‚¨ãƒ©ãƒ¼åŸå› ã®ç‰¹å®š
- [ ] è‡ªå‹•ä¿®å¾©ã®å®Ÿè¡Œ
- [ ] ä¿®å¾©çµæœã®æ¤œè¨¼
- [ ] å…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æˆåŠŸç¢ºèª

---
ğŸ¤– ã“ã®Issueã¯ **GitHub Actions è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ** ã«ã‚ˆã‚Šè‡ªå‹•ç®¡ç†ã•ã‚Œã¦ã„ã¾ã™ã€‚
30åˆ†ã”ã¨ã«æ›´æ–°ã•ã‚Œã¾ã™ã€‚"

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "ğŸ“ æ—¢å­˜Issue #$EXISTING_ISSUE ã‚’æ›´æ–°"
            gh issue edit "$EXISTING_ISSUE" --body "$ISSUE_BODY"
            echo "issue_number=$EXISTING_ISSUE" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ æ–°è¦Issueã‚’ä½œæˆ"
            NEW_ISSUE=$(gh issue create \
              --title "ğŸ”§ [è‡ªå‹•ä¿®å¾©] GitHub Actions ã‚¨ãƒ©ãƒ¼æ¤œçŸ¥ - $(date '+%Y-%m-%d')" \
              --body "$ISSUE_BODY" \
              --label "${{ env.ISSUE_LABEL_AUTO_FIX }},${{ env.ISSUE_LABEL_CI_CD }},${{ env.ISSUE_LABEL_BUG }}" \
              | grep -oE '[0-9]+$')
            echo "issue_number=$NEW_ISSUE" >> $GITHUB_OUTPUT
            echo "âœ… Issue #$NEW_ISSUE ã‚’ä½œæˆã—ã¾ã—ãŸ"
          fi

  # ã‚¸ãƒ§ãƒ–3: è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ
  auto-fix:
    name: ğŸ”§ è‡ªå‹•ä¿®å¾©å®Ÿè¡Œ
    runs-on: ubuntu-latest
    needs: [detect-errors, manage-issue]
    if: needs.detect-errors.outputs.has_failures == 'true'
    timeout-minutes: 360

    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          npm ci || npm install
          if [ -f src/package.json ]; then
            cd src && npm ci || npm install
          fi

      - name: Git è¨­å®š
        run: |
          git config --global user.name "ğŸ¤– GitHub Actions è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ "
          git config --global user.email "auto-fix@github.com"

      - name: ğŸ”„ è‡ªå‹•ä¿®å¾©ãƒ«ãƒ¼ãƒ— (æœ€å¤§10å›, 30åˆ†é–“éš”)
        id: fix_loop
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
          MAX_ATTEMPTS: ${{ github.event.inputs.max_attempts || '10' }}
          INTERVAL_MINUTES: ${{ github.event.inputs.interval_minutes || '30' }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          ISSUE_NUMBER: ${{ needs.manage-issue.outputs.issue_number }}
        run: |
          echo "ğŸ”§ è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•"
          echo "  - æœ€å¤§è©¦è¡Œå›æ•°: $MAX_ATTEMPTS"
          echo "  - è©¦è¡Œé–“éš”: ${INTERVAL_MINUTES}åˆ†"
          echo "  - Issueç•ªå·: #$ISSUE_NUMBER"

          ATTEMPT=1
          TOTAL_FIXES=0

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo ""
            echo "========================================="
            echo "ğŸ”„ è©¦è¡Œ $ATTEMPT / $MAX_ATTEMPTS"
            echo "========================================="

            # å¤±æ•—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å†ç¢ºèª
            CURRENT_FAILURES=$(gh api repos/${{ github.repository }}/actions/runs \
              --jq '.workflow_runs | map(select(.conclusion == "failure" and .name != "ğŸ”§ GitHub Actions è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ ")) | length')

            if [ "$CURRENT_FAILURES" -eq 0 ]; then
              echo "âœ… å…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æˆåŠŸï¼ä¿®å¾©å®Œäº†ï¼"

              # Issueã‚’æ›´æ–°ã—ã¦ã‚¯ãƒ­ãƒ¼ã‚º
              gh issue comment "$ISSUE_NUMBER" --body "## âœ… ä¿®å¾©å®Œäº†

ğŸ‰ å…¨ã¦ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ï¼

- **ä¿®å¾©å®Œäº†æ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S JST')
- **ç·è©¦è¡Œå›æ•°**: $ATTEMPT
- **ç·ä¿®å¾©æ•°**: $TOTAL_FIXES

ã“ã®Issueã¯è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚"

              gh issue close "$ISSUE_NUMBER" --reason completed
              echo "total_fixes=$TOTAL_FIXES" >> $GITHUB_OUTPUT
              echo "final_status=success" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "âš ï¸ $CURRENT_FAILURES ä»¶ã®å¤±æ•—ã‚’æ¤œå‡º"

            # è‡ªå‹•ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            if [ -f scripts/github-actions-auto-fix.js ]; then
              echo "ğŸ“œ è‡ªå‹•ä¿®å¾©ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ..."
              node scripts/github-actions-auto-fix.js || true
              TOTAL_FIXES=$((TOTAL_FIXES + 1))
            fi

            # Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã§é€²æ—å ±å‘Š
            gh issue comment "$ISSUE_NUMBER" --body "### ğŸ”„ ä¿®å¾©è©¦è¡Œ $ATTEMPT / $MAX_ATTEMPTS

- **æ™‚åˆ»**: $(date '+%Y-%m-%d %H:%M:%S JST')
- **æ¤œå‡ºã‚¨ãƒ©ãƒ¼æ•°**: $CURRENT_FAILURES
- **ç´¯è¨ˆä¿®å¾©æ•°**: $TOTAL_FIXES
- **æ¬¡å›è©¦è¡Œ**: ${INTERVAL_MINUTES}åˆ†å¾Œ

---
_è‡ªå‹•ç”Ÿæˆã‚³ãƒ¡ãƒ³ãƒˆ_"

            # æœ€å¾Œã®è©¦è¡Œã§ãªã‘ã‚Œã°å¾…æ©Ÿ
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "â³ ${INTERVAL_MINUTES}åˆ†å¾…æ©Ÿä¸­..."
              sleep $((INTERVAL_MINUTES * 60))
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "âš ï¸ æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸ"
          echo "total_fixes=$TOTAL_FIXES" >> $GITHUB_OUTPUT
          echo "final_status=max_attempts_reached" >> $GITHUB_OUTPUT

          # Issueã«æœ€çµ‚å ±å‘Š
          gh issue comment "$ISSUE_NUMBER" --body "## âš ï¸ æœ€å¤§è©¦è¡Œå›æ•°åˆ°é”

æœ€å¤§è©¦è¡Œå›æ•° ($MAX_ATTEMPTS å›) ã«é”ã—ã¾ã—ãŸãŒã€ä¸€éƒ¨ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒã¾ã å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚

- **æœ€çµ‚è©¦è¡Œæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S JST')
- **ç·ä¿®å¾©æ•°**: $TOTAL_FIXES

### ğŸ¯ æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. æ‰‹å‹•ã§ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„
2. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§ä¿®æ­£ã‚’è¡Œã£ã¦ãã ã•ã„
3. 30åˆ†å¾Œã«å†åº¦è‡ªå‹•ä¿®å¾©ãŒè©¦è¡Œã•ã‚Œã¾ã™

---
_ã“ã®Issueã¯æ‰‹å‹•ã§ã®ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—ãŒå¿…è¦ã§ã™_"

      - name: ğŸ“Š ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-fix-logs-${{ github.run_number }}
          path: |
            logs/auto-fix-*.log
            logs/*.log
          retention-days: 30

      - name: ğŸ“ ä¿®å¾©çµæœã®è¦ç´„
        if: always()
        run: |
          echo "## ğŸ”§ GitHub Actions è‡ªå‹•ä¿®å¾©ã‚·ã‚¹ãƒ†ãƒ  çµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| å®Ÿè¡Œæ—¥æ™‚ | $(date '+%Y-%m-%d %H:%M:%S JST') |" >> $GITHUB_STEP_SUMMARY
          echo "| å®Ÿè¡Œç•ªå· | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æœ€å¤§è©¦è¡Œå›æ•° | ${{ github.event.inputs.max_attempts || '10' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è©¦è¡Œé–“éš” | ${{ github.event.inputs.interval_minutes || '30' }}åˆ† |" >> $GITHUB_STEP_SUMMARY
          echo "| Issue | #${{ needs.manage-issue.outputs.issue_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f logs/auto-fix-*.log ]; then
            echo "### ğŸ“‹ ä¿®å¾©ãƒ­ã‚° (æœ€æ–°20è¡Œ)" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -20 logs/auto-fix-*.log >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "ãƒ­ã‚°ãªã—"
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  # ã‚¸ãƒ§ãƒ–4: æˆåŠŸæ™‚ã®Issueã‚¯ãƒ­ãƒ¼ã‚º
  close-on-success:
    name: âœ… æˆåŠŸæ™‚Issueå‡¦ç†
    runs-on: ubuntu-latest
    needs: detect-errors
    if: needs.detect-errors.outputs.has_failures == 'false'

    steps:
      - name: æˆåŠŸæ™‚ã®æ—¢å­˜Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… å…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ­£å¸¸å‹•ä½œä¸­"

          # æ—¢å­˜ã®auto-fix Issueã‚’æ¤œç´¢ã—ã¦ã‚¯ãƒ­ãƒ¼ã‚º
          EXISTING_ISSUE=$(gh issue list --repo ${{ github.repository }} --label "auto-fix" --state open --json number --jq '.[0].number // empty')

          if [ -n "$EXISTING_ISSUE" ]; then
            echo "ğŸ“ Issue #$EXISTING_ISSUE ã‚’ã‚¯ãƒ­ãƒ¼ã‚º"
            gh issue comment "$EXISTING_ISSUE" --repo ${{ github.repository }} --body "## âœ… å…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ­£å¸¸åŒ–ç¢ºèª

ğŸ‰ å®šæœŸãƒã‚§ãƒƒã‚¯ã®çµæœã€å…¨ã¦ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚

- **ç¢ºèªæ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S JST')

ã“ã®Issueã¯è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã•ã‚Œã¾ã™ã€‚"

            gh issue close "$EXISTING_ISSUE" --repo ${{ github.repository }} --reason completed
            echo "âœ… Issue #$EXISTING_ISSUE ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸ ã‚¯ãƒ­ãƒ¼ã‚ºå¯¾è±¡ã®Issueã¯ã‚ã‚Šã¾ã›ã‚“"
          fi
