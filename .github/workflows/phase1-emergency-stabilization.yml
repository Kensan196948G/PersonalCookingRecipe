# Phase 1: ç·Šæ€¥å®‰å®šåŒ– CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# PostgreSQL + Redisçµ±åˆã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
name: Phase 1 Emergency Stabilization

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.11'
  
  # PostgreSQL è¨­å®š
  POSTGRES_DB: recipe_test_db
  POSTGRES_USER: test_user
  POSTGRES_PASSWORD: test_password
  
  # Redis è¨­å®š
  REDIS_PASSWORD: test_redis_pass
  JWT_CACHE_ENABLED: 'true'
  JWT_CACHE_TTL: '3600'

jobs:
  # ===============================
  # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  # ===============================
  dependencies:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate cache key
      id: cache-key
      run: |
        echo "key=deps-${{ hashFiles('**/package-lock.json', '**/requirements.txt') }}" >> $GITHUB_OUTPUT
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          ~/.cache/pip
          backend/node_modules
          frontend/node_modules
        key: ${{ steps.cache-key.outputs.key }}
        
    - name: Install dependencies
      run: |
        # Backend
        cd src && npm ci
        
        # Frontend
        cd ../frontend && npm ci
        
        # API
        cd ../api && pip install -r requirements.txt

  # ===============================
  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆ
  # ===============================
  database-integration:
    runs-on: ubuntu-latest
    needs: dependencies
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 3s
          --health-retries 5
        ports:
          - 6379:6379
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          backend/node_modules
        key: ${{ needs.dependencies.outputs.cache-key }}
        
    - name: Install dependencies
      run: cd src && npm ci
      
    - name: Database migration test
      env:
        DB_TYPE: postgresql
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: ${{ env.POSTGRES_DB }}
        DB_USER: ${{ env.POSTGRES_USER }}
        DB_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        REDIS_URL: redis://localhost:6379
        REDIS_PASSWORD: ${{ env.REDIS_PASSWORD }}
        JWT_SECRET: test_jwt_secret_key_for_ci_cd
      run: |
        cd src
        node -e "
          const db = require('./src/config/database-postgresql');
          (async () => {
            try {
              console.log('ğŸš€ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç§»è¡Œãƒ†ã‚¹ãƒˆé–‹å§‹...');
              const result = await db.initialize();
              console.log('âœ… PostgreSQL + RedisåˆæœŸåŒ–æˆåŠŸ');
              await db.close();
              console.log('âœ… æ¥ç¶šã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
            } catch (error) {
              console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç§»è¡Œãƒ†ã‚¹ãƒˆå¤±æ•—:', error.message);
              process.exit(1);
            }
          })();
        "

  # ===============================
  # èªè¨¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  # ===============================
  auth-performance-test:
    runs-on: ubuntu-latest
    needs: dependencies
    
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 3s
          --health-retries 5
        ports:
          - 6379:6379
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          backend/node_modules
        key: ${{ needs.dependencies.outputs.cache-key }}
        
    - name: Install dependencies
      run: cd src && npm ci
      
    - name: JWTèªè¨¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
      env:
        REDIS_URL: redis://localhost:6379
        REDIS_PASSWORD: ${{ env.REDIS_PASSWORD }}
        JWT_SECRET: test_jwt_secret_key_for_ci_cd
        JWT_CACHE_ENABLED: 'true'
        JWT_CACHE_TTL: '3600'
      run: |
        cd src
        timeout 60s node -e "
          const auth = require('./src/middleware/auth-optimized');
          (async () => {
            const testUser = { id: 1, username: 'testuser', email: 'test@example.com' };
            const iterations = 100;
            const startTime = Date.now();
            
            console.log('ğŸš€ JWTèªè¨¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            console.log('ğŸ“Š ç›®æ¨™: å¹³å‡500msä»¥ä¸‹ã€100å›å®Ÿè¡Œ');
            
            let totalTime = 0;
            let successCount = 0;
            
            for (let i = 0; i < iterations; i++) {
              const testStart = Date.now();
              
              try {
                // JWTç”Ÿæˆãƒ†ã‚¹ãƒˆ
                const token = await auth.generateToken(testUser);
                
                // JWTæ¤œè¨¼ãƒ†ã‚¹ãƒˆ
                const decoded = await auth.verifyToken(token);
                
                const testTime = Date.now() - testStart;
                totalTime += testTime;
                successCount++;
                
                if (testTime > 500) {
                  console.warn(\`âš ï¸ é…ã„ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: \${testTime}ms (å›æ•°: \${i+1})\`);
                }
                
              } catch (error) {
                console.error(\`âŒ ãƒ†ã‚¹ãƒˆå¤±æ•— (å›æ•°: \${i+1}):\`, error.message);
              }
            }
            
            const avgTime = totalTime / successCount;
            const overallTime = Date.now() - startTime;
            
            console.log('ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœ:');
            console.log(\`   æˆåŠŸç‡: \${successCount}/\${iterations} (\${(successCount/iterations*100).toFixed(1)}%)\`);
            console.log(\`   å¹³å‡æ™‚é–“: \${avgTime.toFixed(1)}ms\`);
            console.log(\`   å…¨ä½“æ™‚é–“: \${overallTime}ms\`);
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å“è³ªã‚²ãƒ¼ãƒˆ
            if (avgTime > 500) {
              console.error(\`ğŸš¨ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶æœªé”æˆ: \${avgTime.toFixed(1)}ms > 500ms\`);
              process.exit(1);
            }
            
            if (successCount < iterations * 0.95) {
              console.error(\`ğŸš¨ æˆåŠŸç‡è¦ä»¶æœªé”æˆ: \${(successCount/iterations*100).toFixed(1)}% < 95%\`);
              process.exit(1);
            }
            
            console.log('âœ… èªè¨¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆæˆåŠŸ');
          })();
        "

  # ===============================
  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ (æ”¹è‰¯ç‰ˆ)
  # ===============================
  backend-tests:
    runs-on: ubuntu-latest
    needs: dependencies
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 3s
          --health-retries 5
        ports:
          - 6379:6379
          
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          backend/node_modules
        key: ${{ needs.dependencies.outputs.cache-key }}
        
    - name: Install dependencies
      run: cd src && npm ci
      
    - name: Run tests with coverage
      env:
        NODE_ENV: test
        DB_TYPE: postgresql
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: ${{ env.POSTGRES_DB }}
        DB_USER: ${{ env.POSTGRES_USER }}
        DB_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        REDIS_URL: redis://localhost:6379
        REDIS_PASSWORD: ${{ env.REDIS_PASSWORD }}
        JWT_SECRET: test_jwt_secret_key_for_ci_cd
      run: |
        cd src
        npm test -- --coverage --passWithNoTests
        
    - name: Coverage quality gate
      run: |
        cd src
        if [ -f coverage/coverage-summary.json ]; then
          node -e "
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
            const threshold = 50; // ç¾çŠ¶37.36%ã‹ã‚‰æ®µéšçš„ã«å‘ä¸Š
            const actual = coverage.total.lines.pct;
            
            console.log(\`ğŸ“Š ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸: \${actual}% (ç›®æ¨™: \${threshold}%)\`);
            
            if (actual < threshold) {
              console.error(\`ğŸš¨ ã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶æœªé”æˆ: \${actual}% < \${threshold}%\`);
              process.exit(1);
            }
            
            console.log('âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶é”æˆ');
          "
        fi

  # ===============================
  # ã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ (Native)
  # ===============================
  system-integration:
    runs-on: ubuntu-latest
    needs: [database-integration, auth-performance-test, backend-tests]

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 3s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Install dependencies
      run: |
        cd src && npm ci

    - name: Health check all services (Native)
      env:
        DB_TYPE: postgresql
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: ${{ env.POSTGRES_DB }}
        DB_USER: ${{ env.POSTGRES_USER }}
        DB_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        REDIS_URL: redis://localhost:6379
      run: |
        echo "ğŸ¥ ã‚µãƒ¼ãƒ“ã‚¹ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯é–‹å§‹ (Native Environment)..."

        # PostgreSQLæ¥ç¶šãƒ†ã‚¹ãƒˆ
        cd src
        node -e "
          const { Pool } = require('pg');
          const pool = new Pool({
            host: process.env.DB_HOST,
            port: process.env.DB_PORT,
            database: process.env.DB_NAME,
            user: process.env.DB_USER,
            password: process.env.DB_PASSWORD
          });

          (async () => {
            try {
              const result = await pool.query('SELECT 1');
              console.log('âœ… PostgreSQLæ¥ç¶šæˆåŠŸ');
              await pool.end();
            } catch (error) {
              console.error('âŒ PostgreSQLæ¥ç¶šå¤±æ•—:', error.message);
              process.exit(1);
            }
          })();
        "

        # Redisæ¥ç¶šãƒ†ã‚¹ãƒˆ
        node -e "
          const redis = require('redis');
          const client = redis.createClient({ url: process.env.REDIS_URL });

          (async () => {
            try {
              await client.connect();
              await client.ping();
              console.log('âœ… Redisæ¥ç¶šæˆåŠŸ');
              await client.quit();
            } catch (error) {
              console.error('âŒ Redisæ¥ç¶šå¤±æ•—:', error.message);
              process.exit(1);
            }
          })();
        "

        echo "âœ… å…¨ã‚µãƒ¼ãƒ“ã‚¹ç¨¼åƒç¢ºèªå®Œäº† (Native Environment)"

  # ===============================
  # å“è³ªã‚µãƒãƒªãƒ¼ãƒ¬ãƒãƒ¼ãƒˆ
  # ===============================
  quality-report:
    runs-on: ubuntu-latest
    needs: [database-integration, auth-performance-test, backend-tests, system-integration]
    if: always()
    
    steps:
    - name: Generate Quality Report
      run: |
        echo "# ğŸ“Š Phase 1 å“è³ªãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ¯ ç·Šæ€¥å®‰å®šåŒ–çµæœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.database-integration.result }}" == "success" ]]; then
          echo "âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç§»è¡Œ**: PostgreSQL + Redisçµ±åˆæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç§»è¡Œ**: å¤±æ•— - ä¿®æ­£ãŒå¿…è¦" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ needs.auth-performance-test.result }}" == "success" ]]; then
          echo "âœ… **èªè¨¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ç›®æ¨™é”æˆï¼ˆ<500msï¼‰" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **èªè¨¼ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ç›®æ¨™æœªé”æˆ - æœ€é©åŒ–ãŒå¿…è¦" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ needs.backend-tests.result }}" == "success" ]]; then
          echo "âœ… **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ**: å“è³ªåŸºæº–ã‚¯ãƒªã‚¢" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ**: ä¿®æ­£ãŒå¿…è¦" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [[ "${{ needs.system-integration.result }}" == "success" ]]; then
          echo "âœ… **ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ**: å…¨ã‚µãƒ¼ãƒ“ã‚¹é€£æºç¢ºèª" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ**: ã‚µãƒ¼ãƒ“ã‚¹é–“é€£æºã«å•é¡Œã‚ã‚Š" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“ˆ æ¬¡ã‚¹ãƒ†ãƒƒãƒ—" >> $GITHUB_STEP_SUMMARY
        echo "- Phase 2: å“è³ªãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ (2-4é€±é–“)" >> $GITHUB_STEP_SUMMARY
        echo "- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸å‘ä¸Š (37% â†’ 80%)" >> $GITHUB_STEP_SUMMARY
        echo "- APIæœ€é©åŒ–ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥å®Ÿè£…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*PersonalCookingRecipe CI/CD Pipeline*" >> $GITHUB_STEP_SUMMARY