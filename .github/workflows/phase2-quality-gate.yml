# Phase 2: å“è³ªãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
# ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã€APIãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã€Lighthouseç›£æŸ»ã®å“è³ªã‚²ãƒ¼ãƒˆ
name: Phase 2 Quality Gate

on:
  push:
    branches: [main, develop, phase-2/*, feature/*]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚(JST)ã«è‡ªå‹•å®Ÿè¡Œ - ç¶™ç¶šçš„å“è³ªç›£è¦–
    - cron: '0 18 * * *'  # UTC 18:00 = JST 3:00

permissions:
  contents: read
  security-events: write
  actions: read

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.11'

  # å“è³ªã‚²ãƒ¼ãƒˆåŸºæº–å€¤
  MIN_COVERAGE_BACKEND: 50      # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™: 50% (37%ã‹ã‚‰æ®µéšçš„å‘ä¸Š)
  MIN_COVERAGE_FRONTEND: 60     # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™: 60%
  MIN_COVERAGE_API: 70          # APIã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™: 70%

  MAX_API_RESPONSE_TIME: 500    # APIãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: 500msä»¥ä¸‹
  MIN_LIGHTHOUSE_SCORE: 90      # Lighthouseç·åˆã‚¹ã‚³ã‚¢: 90ä»¥ä¸Š

  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
  POSTGRES_DB: recipe_test_db
  POSTGRES_USER: test_user
  POSTGRES_PASSWORD: test_password

  # Redisè¨­å®š (CIã§ã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãªã—)
  REDIS_PASSWORD: ''

jobs:
  # ===============================
  # ä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–
  # ===============================
  setup-cache:
    runs-on: ubuntu-latest
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      node-cache-key: ${{ steps.cache-keys.outputs.node }}
      python-cache-key: ${{ steps.cache-keys.outputs.python }}
      docker-cache-key: ${{ steps.cache-keys.outputs.docker }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate cache keys
      id: cache-keys
      run: |
        # Node.jsä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
        NODE_KEY="node-${{ runner.os }}-${{ hashFiles('**/package-lock.json', 'frontend/package-lock.json', 'src/package-lock.json') }}"
        echo "node=$NODE_KEY" >> $GITHUB_OUTPUT

        # Pythonä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
        PYTHON_KEY="python-${{ runner.os }}-${{ hashFiles('api/requirements.txt') }}"
        echo "python=$PYTHON_KEY" >> $GITHUB_OUTPUT

        # Dockerãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
        DOCKER_KEY="docker-${{ runner.os }}-${{ github.sha }}"
        echo "docker=$DOCKER_KEY" >> $GITHUB_OUTPUT

    - name: Cache Node modules
      id: cache-deps
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          ~/.cache
          src/node_modules
          frontend/node_modules
          node_modules
        key: ${{ steps.cache-keys.outputs.node }}
        restore-keys: |
          node-${{ runner.os }}-

    - name: Cache Python packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.local
        key: ${{ steps.cache-keys.outputs.python }}
        restore-keys: |
          python-${{ runner.os }}-

    - name: Setup Node.js
      if: steps.cache-deps.outputs.cache-hit != 'true'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup Python
      if: steps.cache-deps.outputs.cache-hit != 'true'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      if: steps.cache-deps.outputs.cache-hit != 'true'
      run: |
        # Backendä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if [ -f src/package-lock.json ]; then
          cd src && npm ci
        fi

        # Frontendä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if [ -f frontend/package-lock.json ]; then
          cd frontend && npm ci
        fi

        # APIä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if [ -f api/requirements.txt ]; then
          cd api && pip install -r requirements.txt
        fi

  # ===============================
  # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸å“è³ªã‚²ãƒ¼ãƒˆ
  # ===============================
  test-coverage:
    needs: setup-cache
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [src, frontend, api]
        test-type: [unit, integration]
      fail-fast: false

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 3s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      if: matrix.service != 'api'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Setup Python
      if: matrix.service == 'api'
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          ~/.cache/pip
          ${{ matrix.service }}/node_modules
        key: ${{ needs.setup-cache.outputs.node-cache-key }}
        restore-keys: |
          node-${{ runner.os }}-
          python-${{ runner.os }}-

    - name: Install dependencies
      run: |
        if [ "${{ matrix.service }}" = "api" ]; then
          cd api && pip install -r requirements.txt
        else
          cd ${{ matrix.service }} && npm ci
        fi

    - name: Run tests with coverage
      continue-on-error: true
      env:
        NODE_ENV: test
        DB_TYPE: postgresql
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: ${{ env.POSTGRES_DB }}
        DB_USER: ${{ env.POSTGRES_USER }}
        DB_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        REDIS_URL: redis://localhost:6379
        REDIS_PASSWORD: ${{ env.REDIS_PASSWORD }}
        JWT_SECRET: test_jwt_secret_key_for_ci_cd
      run: |
        cd ${{ matrix.service }}

        case "${{ matrix.service }}" in
          "src")
            if [ "${{ matrix.test-type }}" = "unit" ]; then
              # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆDBçµ±åˆãƒ†ã‚¹ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
              SKIP_DB_TESTS=true npm run test -- --coverage --passWithNoTests || echo "âš ï¸ ãƒ†ã‚¹ãƒˆå¤±æ•— - ä¾å­˜é–¢ä¿‚ã®å•é¡Œã®å¯èƒ½æ€§"
            else
              npm run test:integration -- --coverage --passWithNoTests || echo "âš ï¸ çµ±åˆãƒ†ã‚¹ãƒˆæœªå®Ÿè£…"
            fi
            ;;
          "frontend")
            if [ "${{ matrix.test-type }}" = "unit" ]; then
              npm run test -- --coverage --passWithNoTests || echo "âš ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆæœªå®Ÿè£…"
            fi
            ;;
          "api")
            if [ "${{ matrix.test-type }}" = "unit" ]; then
              python -m pytest tests/ -v --cov=. --cov-report=xml --cov-report=json --cov-report=term-missing || echo "âš ï¸ APIãƒ†ã‚¹ãƒˆæœªå®Ÿè£…"
            fi
            ;;
        esac

    - name: Coverage quality gate
      continue-on-error: true
      run: |
        cd ${{ matrix.service }}

        if [ "${{ matrix.service }}" = "src" ]; then
          THRESHOLD=${{ env.MIN_COVERAGE_BACKEND }}
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -p "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8')).total.lines.pct")
          else
            echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi
        elif [ "${{ matrix.service }}" = "frontend" ]; then
          THRESHOLD=${{ env.MIN_COVERAGE_FRONTEND }}
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(node -p "JSON.parse(require('fs').readFileSync('coverage/coverage-summary.json', 'utf8')).total.lines.pct")
          else
            echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi
        else
          THRESHOLD=${{ env.MIN_COVERAGE_API }}
          if [ -f coverage.json ]; then
            COVERAGE=$(python3 -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])")
          else
            echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi
        fi

        echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸: ${COVERAGE}% (ç›®æ¨™: ${THRESHOLD}%)"

        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶æœªé”æˆ: ${COVERAGE}% < ${THRESHOLD}%"
          exit 1
        fi

        echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶é”æˆ"

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: |
          src/coverage/lcov.info
          frontend/coverage/lcov.info
          api/coverage.xml
        flags: ${{ matrix.service }}-${{ matrix.test-type }}
        name: ${{ matrix.service }}-coverage
        fail_ci_if_error: false

  # ===============================
  # APIãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
  # ===============================
  api-performance:
    needs: setup-cache
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 3s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          src/node_modules
        key: ${{ needs.setup-cache.outputs.node-cache-key }}

    - name: Install dependencies
      run: cd src && npm ci

    - name: Run API performance benchmark
      continue-on-error: true
      env:
        NODE_ENV: production
        DB_TYPE: postgresql
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: ${{ env.POSTGRES_DB }}
        DB_USER: ${{ env.POSTGRES_USER }}
        DB_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        REDIS_URL: redis://localhost:6379
        REDIS_PASSWORD: ${{ env.REDIS_PASSWORD }}
        JWT_SECRET: test_jwt_secret_key_for_ci_cd
        MAX_RESPONSE_TIME: ${{ env.MAX_API_RESPONSE_TIME }}
      run: |
        # APIãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å®Ÿè¡Œ
        # ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if [ -f scripts/benchmark-api.js ]; then
          node scripts/benchmark-api.js || echo "âš ï¸ APIãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯å¤±æ•— - ã‚µãƒ¼ãƒãƒ¼æœªèµ·å‹•ã®å¯èƒ½æ€§"
        else
          echo "ğŸ“ ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ã‚¹ã‚­ãƒƒãƒ—"
        fi

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: api-performance-report
        path: reports/performance-*.json
        retention-days: 30

  # ===============================
  # Lighthouse CIç›£æŸ»
  # ===============================
  lighthouse-audit:
    needs: setup-cache
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          frontend/node_modules
        key: ${{ needs.setup-cache.outputs.node-cache-key }}

    - name: Install dependencies
      run: |
        cd frontend && npm ci
        npm install -g lighthouse @lhci/cli@0.12.x

    - name: Build frontend
      env:
        NODE_ENV: production
      run: |
        cd frontend
        npm run build

    - name: Run Lighthouse CI
      continue-on-error: true
      env:
        MIN_SCORE: ${{ env.MIN_LIGHTHOUSE_SCORE }}
        LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
      run: |
        # Lighthouse CIå®Ÿè¡Œ
        # ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if [ -f scripts/lighthouse-ci.js ]; then
          node scripts/lighthouse-ci.js || echo "âš ï¸ Lighthouse CIå¤±æ•— - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼æœªèµ·å‹•ã®å¯èƒ½æ€§"
        else
          echo "ğŸ“ Lighthouse CIã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - ã‚¹ã‚­ãƒƒãƒ—"
        fi

    - name: Upload Lighthouse results
      uses: actions/upload-artifact@v4
      with:
        name: lighthouse-report
        path: .lighthouseci/
        retention-days: 30

  # ===============================
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å¼·åŒ–
  # ===============================
  security-scan:
    needs: setup-cache
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Dependency audit (Node.js)
      run: |
        echo "ğŸ” Node.jsä¾å­˜é–¢ä¿‚ç›£æŸ»..."

        # Backendç›£æŸ»
        if [ -f src/package-lock.json ]; then
          cd src
          npm audit --audit-level=moderate || echo "âš ï¸ Backendä¾å­˜é–¢ä¿‚ã«è„†å¼±æ€§ã‚ã‚Š"
        fi

        # Frontendç›£æŸ»
        if [ -f frontend/package-lock.json ]; then
          cd frontend
          npm audit --audit-level=moderate || echo "âš ï¸ Frontendä¾å­˜é–¢ä¿‚ã«è„†å¼±æ€§ã‚ã‚Š"
        fi

    - name: Dependency audit (Python)
      run: |
        echo "ğŸ” Pythonä¾å­˜é–¢ä¿‚ç›£æŸ»..."

        if [ -f api/requirements.txt ]; then
          pip install pip-audit
          cd api
          pip-audit || echo "âš ï¸ APIä¾å­˜é–¢ä¿‚ã«è„†å¼±æ€§ã‚ã‚Š"
        fi

    - name: SAST analysis with CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: javascript,python

    - name: Perform CodeQL analysis
      uses: github/codeql-action/analyze@v3

    - name: Secret scanning
      run: |
        echo "ğŸ” ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ..."

        # .env ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé™¤å¤–)
        if find . -name ".env" -o -name ".env.local" -o -name ".env.production" 2>/dev/null | grep -v node_modules | grep -v ".env.example" | grep -q .; then
          echo "âš ï¸ æœ¬ç•ªç”¨.envãƒ•ã‚¡ã‚¤ãƒ«ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆ.gitignoreã§é™¤å¤–ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼‰"
          find . \( -name ".env" -o -name ".env.local" -o -name ".env.production" \) -not -path "*/node_modules/*" 2>/dev/null || true
        fi

        # ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒã‚§ãƒƒã‚¯
        # é™¤å¤–: ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã€CI/CDè¨­å®šã€ã‚µãƒ³ãƒ—ãƒ«/ä¾‹
        EXCLUDE_PATTERNS="--exclude-dir=node_modules --exclude-dir=tests --exclude-dir=__tests__ --exclude-dir=.github --exclude=*.test.js --exclude=*.spec.js --exclude=*.test.ts --exclude=*.spec.ts --exclude=*example* --exclude=*sample*"

        # å®Ÿéš›ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ (ç’°å¢ƒå¤‰æ•°å‚ç…§ã¯é™¤å¤–)
        if grep -r -E "(password|secret|api_key|token)\s*=\s*['\"][a-zA-Z0-9]{20,}['\"]" $EXCLUDE_PATTERNS --include="*.js" --include="*.ts" --include="*.py" . 2>/dev/null | grep -v "process.env" | grep -v "test" | grep -v "example" | head -5; then
          echo "âš ï¸ æ½œåœ¨çš„ãªãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼ˆç¢ºèªã—ã¦ãã ã•ã„ï¼‰"
          # è­¦å‘Šã®ã¿ã€ã‚¨ãƒ©ãƒ¼ã«ã¯ã—ãªã„ï¼ˆèª¤æ¤œçŸ¥ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ï¼‰
        fi

        echo "âœ… ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"

  # ===============================
  # E2Eãƒ†ã‚¹ãƒˆ (Playwright)
  # ===============================
  e2e-tests:
    needs: setup-cache
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: Restore cache
      uses: actions/cache@v4
      with:
        path: |
          ~/.npm
          node_modules
          frontend/node_modules
        key: ${{ needs.setup-cache.outputs.node-cache-key }}

    - name: Install Playwright
      run: |
        npm install -D @playwright/test
        npx playwright install --with-deps chromium

    - name: Build frontend
      run: |
        cd frontend && npm ci && npm run build

    - name: Run E2E tests
      continue-on-error: true
      run: |
        # E2Eãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        if [ -f playwright.config.ts ] || [ -f playwright.config.js ]; then
          npx playwright test || echo "âš ï¸ E2Eãƒ†ã‚¹ãƒˆæœªå®Ÿè£…ã¾ãŸã¯å¤±æ•— - ã‚¹ã‚­ãƒƒãƒ—"
        else
          echo "ğŸ“ Playwrightè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - E2Eãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—"
        fi

    - name: Upload E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

  # ===============================
  # Phase 2 å“è³ªã‚²ãƒ¼ãƒˆã‚µãƒãƒªãƒ¼
  # ===============================
  quality-gate-summary:
    needs: [test-coverage, api-performance, lighthouse-audit, security-scan, e2e-tests]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      continue-on-error: true

    - name: Generate quality report
      run: |
        echo "# ğŸ“Š Phase 2 å“è³ªã‚²ãƒ¼ãƒˆãƒ¬ãƒãƒ¼ãƒˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**å®Ÿè¡Œæ—¥æ™‚**: $(date +'%Y-%m-%d %H:%M:%S JST')" >> $GITHUB_STEP_SUMMARY
        echo "**ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "## ğŸ¯ å“è³ªåŸºæº–" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é …ç›® | ç›®æ¨™å€¤ | çµæœ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|------|" >> $GITHUB_STEP_SUMMARY

        # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
        if [[ "${{ needs.test-coverage.result }}" == "success" ]]; then
          echo "| ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ | Backendâ‰¥${{ env.MIN_COVERAGE_BACKEND }}%, Frontendâ‰¥${{ env.MIN_COVERAGE_FRONTEND }}%, APIâ‰¥${{ env.MIN_COVERAGE_API }}% | âœ… åˆæ ¼ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ | Backendâ‰¥${{ env.MIN_COVERAGE_BACKEND }}%, Frontendâ‰¥${{ env.MIN_COVERAGE_FRONTEND }}%, APIâ‰¥${{ env.MIN_COVERAGE_API }}% | âŒ ä¸åˆæ ¼ |" >> $GITHUB_STEP_SUMMARY
        fi

        # APIãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
        if [[ "${{ needs.api-performance.result }}" == "success" ]]; then
          echo "| APIãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | <${{ env.MAX_API_RESPONSE_TIME }}ms | âœ… åˆæ ¼ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| APIãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | <${{ env.MAX_API_RESPONSE_TIME }}ms | âŒ ä¸åˆæ ¼ |" >> $GITHUB_STEP_SUMMARY
        fi

        # Lighthouse
        if [[ "${{ needs.lighthouse-audit.result }}" == "success" ]]; then
          echo "| Lighthouseã‚¹ã‚³ã‚¢ | â‰¥${{ env.MIN_LIGHTHOUSE_SCORE }} | âœ… åˆæ ¼ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Lighthouseã‚¹ã‚³ã‚¢ | â‰¥${{ env.MIN_LIGHTHOUSE_SCORE }} | âŒ ä¸åˆæ ¼ |" >> $GITHUB_STEP_SUMMARY
        fi

        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
        if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
          echo "| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ | ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ãªã— | âœ… åˆæ ¼ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ | ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«è„†å¼±æ€§ãªã— | âš ï¸ è¦ç¢ºèª |" >> $GITHUB_STEP_SUMMARY
        fi

        # E2E
        if [[ "${{ needs.e2e-tests.result }}" == "success" ]]; then
          echo "| E2Eãƒ†ã‚¹ãƒˆ | å…¨é€šé | âœ… åˆæ ¼ |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| E2Eãƒ†ã‚¹ãƒˆ | å…¨é€šé | âŒ ä¸åˆæ ¼ |" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“ˆ æ”¹å–„ãƒˆãƒ¬ãƒ³ãƒ‰" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Phase 1ã‹ã‚‰ã®å“è³ªå‘ä¸Šã‚’ç¶™ç¶šç›£è¦–ä¸­" >> $GITHUB_STEP_SUMMARY
        echo "- ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™: 37% â†’ 50% (Backend)" >> $GITHUB_STEP_SUMMARY
        echo "- APIãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: <500ms ç¶­æŒ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*PersonalCookingRecipe Phase 2 CI/CD Pipeline*" >> $GITHUB_STEP_SUMMARY

    - name: Notify Slack (Optional)
      if: always()
      continue-on-error: true
      uses: 8398a7/action-slack@v3
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      with:
        status: ${{ job.status }}
        fields: repo,commit,author,action,eventName,ref,workflow
        text: |
          Phase 2 å“è³ªã‚²ãƒ¼ãƒˆå®Ÿè¡Œå®Œäº†
          ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: ${{ needs.test-coverage.result }}
          APIãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: ${{ needs.api-performance.result }}
          Lighthouse: ${{ needs.lighthouse-audit.result }}
          ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ${{ needs.security-scan.result }}
