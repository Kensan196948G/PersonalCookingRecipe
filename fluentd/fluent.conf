# Fluentd設定ファイル
# Personal Cooking Recipe Log Collection

# 入力源設定
<source>
  @type tail
  @id frontend_logs
  path /var/log/input/frontend/*.log
  pos_file /var/log/fluentd/frontend.log.pos
  tag recipe.frontend
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%LZ
  </parse>
</source>

<source>
  @type tail
  @id backend_logs  
  path /var/log/input/backend/*.log
  pos_file /var/log/fluentd/backend.log.pos
  tag recipe.backend
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%LZ
  </parse>
</source>

<source>
  @type tail
  @id api_logs
  path /var/log/input/api/*.log
  pos_file /var/log/fluentd/api.log.pos
  tag recipe.api
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%LZ
  </parse>
</source>

<source>
  @type tail
  @id nginx_access
  path /var/log/input/nginx/access.log
  pos_file /var/log/fluentd/nginx_access.log.pos
  tag recipe.nginx.access
  <parse>
    @type nginx
  </parse>
</source>

<source>
  @type tail
  @id nginx_error
  path /var/log/input/nginx/error.log
  pos_file /var/log/fluentd/nginx_error.log.pos
  tag recipe.nginx.error
  <parse>
    @type multiline
    format_firstline /\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}/
    format1 /^(?<time>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<pid>\d+).(?<tid>\d+): (?<message>.*)/
    time_format %Y/%m/%d %H:%M:%S
  </parse>
</source>

# フィルタリング・変換
<filter recipe.**>
  @type record_transformer
  <record>
    hostname "#{Socket.gethostname}"
    service_name ${tag_parts[1]}
    timestamp ${time}
  </record>
</filter>

# エラーレベルのログを抽出
<filter recipe.**>
  @type grep
  <regexp>
    key level
    pattern ^(error|fatal|critical)$
  </regexp>
</filter>

# ログレベル正規化
<filter recipe.**>
  @type record_transformer
  enable_ruby true
  <record>
    level ${record["level"]&.downcase || "info"}
    component ${record["service_name"] || "unknown"}
  </record>
</filter>

# 出力設定 - ファイルローテーション
<match recipe.**>
  @type file
  @id output_file
  path /var/log/fluentd/recipe
  append true
  time_slice_format %Y%m%d
  time_slice_wait 1m
  time_format %Y%m%dT%H%M%S%z
  buffer_type file
  buffer_path /var/log/fluentd/recipe.*.buffer
  flush_interval 10s
  <format>
    @type json
  </format>
</match>

# 高優先度ログ（エラー・警告）を即座に出力
<match recipe.**.{error,warn,fatal}>
  @type file
  @id output_priority
  path /var/log/fluentd/priority/recipe_priority
  append true
  time_slice_format %Y%m%d%H
  time_slice_wait 10s
  buffer_type file
  buffer_path /var/log/fluentd/priority.*.buffer
  flush_interval 1s
  <format>
    @type json
  </format>
</match>

# システム統計
<source>
  @type monitor_agent
  bind 0.0.0.0
  port 24220
</source>